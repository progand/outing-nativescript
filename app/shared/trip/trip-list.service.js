"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var Rx_1 = require("rxjs/Rx");
require("rxjs/add/operator/map");
var config_1 = require("../config");
var trip_1 = require("./trip");
var TripListService = (function () {
    function TripListService(http) {
        this.http = http;
    }
    TripListService.prototype.load = function () {
        var _this = this;
        return this.http.get(config_1.Config.apiUrl + "/models/trips?action=includeRelationships")
            .map(function (res) { return res.json(); })
            .map(function (data) {
            var list = [];
            var trips = _this.deserialize(data);
            trips.forEach(function (trip) {
                list.push(new trip_1.Trip(trip.id, trip.name, trip.destination, null, null, null, trip.budgetFrom, trip.budgetTo, trip.approvedTravellersCount, trip.partnersReqd, trip.coverPhoto, trip.organiser, new Date(trip.dateStart), new Date(trip.dateEnd), null, null, null));
            });
            return list;
        })
            .catch(this.handleErrors);
    };
    TripListService.prototype.loadOne = function (id) {
        var _this = this;
        var promise = this.http.get(config_1.Config.apiUrl + "/models/trips/" + id)
            .toPromise()
            .then(function (res) { return res.json(); })
            .then(function (data) { return data.trip; })
            .then(function (trip) { return Promise.all([
            trip,
            _this.http.get(config_1.Config.apiUrl + "/models/travellers/?ids[]=" + trip.travellers.join("&ids[]="))
                .toPromise()
                .then(function (res) { return res.json(); })
                .then(function (data) { return data.travellers; })
        ]); })
            .then(function (_a) {
            var trip = _a[0], travellers = _a[1];
            return Promise.all([
                trip,
                travellers,
                _this.http.get(config_1.Config.apiUrl + "/models/users/?ids[]=" + travellers
                    .reduce(function (result, travellerData) { return result.concat([travellerData.user]); }, [])
                    .join("&ids[]="))
                    .toPromise()
                    .then(function (res) { return res.json(); })
                    .then(function (data) { return data.users; })
            ]);
        })
            .then(function (_a) {
            var trip = _a[0], travellers = _a[1], users = _a[2];
            return Promise.all([
                trip,
                travellers,
                users,
                _this.http.get(config_1.Config.apiUrl + "/models/photos/?ids[]=" + trip.photos
                    .concat(travellers.reduce(function (result, traveller) {
                    var user = _this.getByValue(users, traveller.user);
                    return result.concat([user.photo]);
                }, []))
                    .join("&ids[]="))
                    .toPromise()
                    .then(function (res) { return res.json(); })
                    .then(function (data) { return data.photos; })
            ]);
        })
            .then(function (_a) {
            var trip = _a[0], travellers = _a[1], users = _a[2], photos = _a[3];
            return Object.assign({}, trip, {
                coverPhoto: _this.getByValue(photos, trip.coverPhoto),
                photos: trip.photos.map(function (photoId) { return _this.getByValue(photos, photoId); }),
                travellers: trip.travellers
                    .map(function (travellerId) { return _this.getByValue(travellers, travellerId); })
                    .map(function (traveller) {
                    var user = _this.getByValue(users, traveller.user);
                    //console.dir(user);
                    //console.dir(photos)
                    return Object.assign({}, traveller, {
                        user: Object.assign({}, user, {
                            photo: _this.getByValue(photos, user.photo)
                        })
                    });
                })
            });
        });
        return Rx_1.Observable.fromPromise(promise);
    };
    TripListService.prototype.handleErrors = function (error) {
        console.log(JSON.stringify(error.json()));
        return Rx_1.Observable.throw(error);
    };
    TripListService.prototype.deserialize = function (data) {
        var _this = this;
        var trips = data.trips, photos = data.photos, users = data.users;
        var result = trips.map(function (item) {
            var organiserData = _this.getByValue(users, item.organiser);
            var organiser = Object.assign({}, organiserData, {
                photo: _this.getByValue(photos, organiserData.photo),
                photos: organiserData.photos.map(function (photoId) { return _this.getByValue(photos, photoId); })
            });
            var trip = Object.assign({}, item, {
                coverPhoto: _this.getByValue(photos, item.coverPhoto),
                photos: item.photos.map(function (photoId) { return _this.getByValue(photos, photoId); }),
                organiser: organiser
            });
            return trip;
        });
        return result;
    };
    TripListService.prototype.getByValue = function (collection, fieldValue, fieldName) {
        if (fieldName === void 0) { fieldName = 'id'; }
        return collection.find(function (item) { return item[fieldName] === fieldValue; });
    };
    return TripListService;
}());
TripListService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [http_1.Http])
], TripListService);
exports.TripListService = TripListService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpcC1saXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmlwLWxpc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUMzQyxzQ0FBd0Q7QUFDeEQsOEJBQXFDO0FBQ3JDLGlDQUErQjtBQUUvQixvQ0FBbUM7QUFDbkMsK0JBQThCO0FBRzlCLElBQWEsZUFBZTtJQUN4Qix5QkFBb0IsSUFBVTtRQUFWLFNBQUksR0FBSixJQUFJLENBQU07SUFBSSxDQUFDO0lBRW5DLDhCQUFJLEdBQUo7UUFBQSxpQkE2QkM7UUE1QkcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQU0sQ0FBQyxNQUFNLEdBQUcsMkNBQTJDLENBQUM7YUFDNUUsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFWLENBQVUsQ0FBQzthQUN0QixHQUFHLENBQUMsVUFBQSxJQUFJO1lBQ0wsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQ2QsSUFBTSxLQUFLLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSTtnQkFDZixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksV0FBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQ3RCLElBQUksQ0FBQyxJQUFJLEVBQ1QsSUFBSSxDQUFDLFdBQVcsRUFDaEIsSUFBSSxFQUNKLElBQUksRUFDSixJQUFJLEVBQ0osSUFBSSxDQUFDLFVBQVUsRUFDZixJQUFJLENBQUMsUUFBUSxFQUNiLElBQUksQ0FBQyx1QkFBdUIsRUFDNUIsSUFBSSxDQUFDLFlBQVksRUFDakIsSUFBSSxDQUFDLFVBQVUsRUFDZixJQUFJLENBQUMsU0FBUyxFQUNkLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFDeEIsSUFBSSxJQUFJLENB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LEVBQUUsS0FBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQztnQkFDcEQsTUFBTSxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLFVBQUEsT0FBTyxJQUFJLE9BQUEsS0FBSSxDQUFDLFVBQVUsQ0FBQyxNQUFNLEVBQUUsT0FBTyxDQUFDLEVBQWhDLENBQWdDLENBQUM7Z0JBQ3BFLFNBQVMsV0FBQTthQUNaLENBQUMsQ0FBQztZQUNILE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFDaEIsQ0FBQyxDQUFDLENBQUM7UUFFSCxNQUFNLENBQUMsTUFBTSxDQUFDO0lBQ2xCLENBQUM7SUFFRCxvQ0FBVSxHQUFWLFVBQVcsVUFBVSxFQUFFLFVBQVUsRUFBRSxTQUFnQjtRQUFoQiwwQkFBQSxFQUFBLGdCQUFnQjtRQUMvQyxNQUFNLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxVQUFBLElBQUksSUFBSSxPQUFBLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxVQUFVLEVBQTlCLENBQThCLENBQUMsQ0FBQztJQUNuRSxDQUFDO0lBQ0wsc0JBQUM7QUFBRCxDQUFDLEFBcEhELElBb0hDO0FBcEhZLGVBQWU7SUFEM0IsaUJBQVUsRUFBRTtxQ0FFaUIsV0FBSTtHQURyQixlQUFlLENBb0gzQjtBQXBIWSwwQ0FBZSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEluamVjdGFibGUgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IHsgSHR0cCwgSGVhZGVycywgUmVzcG9uc2UgfSBmcm9tIFwiQGFuZ3VsYXIvaHR0cFwiO1xuaW1wb3J0IHsgT2JzZXJ2YWJsZSB9IGZyb20gXCJyeGpzL1J4XCI7XG5pbXBvcnQgXCJyeGpzL2FkZC9vcGVyYXRvci9tYXBcIjtcblxuaW1wb3J0IHsgQ29uZmlnIH0gZnJvbSBcIi4uL2NvbmZpZ1wiO1xuaW1wb3J0IHsgVHJpcCB9IGZyb20gXCIuL3RyaXBcIjtcblxuQEluamVjdGFibGUoKVxuZXhwb3J0IGNsYXNzIFRyaXBMaXN0U2VydmljZSB7XG4gICAgY29uc3RydWN0b3IocHJpdmF0ZSBodHRwOiBIdHRwKSB7IH1cblxuICAgIGxvYWQoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLmh0dHAuZ2V0KENvbmZpZy5hcGlVcmwgKyBcIi9tb2RlbHMvdHJpcHM/YWN0aW9uPWluY2x1ZGVSZWxhdGlvbnNoaXBzXCIpXG4gICAgICAgICAgICAubWFwKHJlcyA9PiByZXMuanNvbigpKVxuICAgICAgICAgICAgLm1hcChkYXRhID0+IHtcbiAgICAgICAgICAgICAgICBsZXQgbGlzdCA9IFtdO1xuICAgICAgICAgICAgICAgIGNvbnN0IHRyaXBzID0gdGhpcy5kZXNlcmlhbGl6ZShkYXRhKTtcbiAgICAgICAgICAgICAgICB0cmlwcy5mb3JFYWNoKCh0cmlwKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGxpc3QucHVzaChuZXcgVHJpcCh0cmlwLmlkLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5uYW1lLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5kZXN0aW5hdGlvbixcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAuYnVkZ2V0RnJvbSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAuYnVkZ2V0VG8sXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLmFwcHJvdmVkVHJhdmVsbGVyc0NvdW50LFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5wYXJ0bmVyc1JlcWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLmNvdmVyUGhvdG8sXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLm9yZ2FuaXNlcixcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKHRyaXAuZGF0ZVN0YXJ0KSxcbiAgICAgICAgICAgICAgICAgICAgICAgIG5ldyBEYXRlKHRyaXAuZGF0ZUVuZCksXG4gICAgICAgICAgICAgICAgICAgICAgICBudWxsLFxuICAgICAgICAgICAgICAgICAgICAgICAgbnVsbCxcbiAgICAgICAgICAgICAgICAgICAgICAgIG51bGwsXG4gICAgICAgICAgICAgICAgICAgICkpO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIHJldHVybiBsaXN0O1xuICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIC5jYXRjaCh0aGlzLmhhbmRsZUVycm9ycyk7XG4gICAgfVxuXG4gICAgbG9hZE9uZShpZDogU3RyaW5nKSB7XG4gICAgICAgIGNvbnN0IHByb21pc2UgPSB0aGlzLmh0dHAuZ2V0KENvbmZpZy5hcGlVcmwgKyBcIi9tb2RlbHMvdHJpcHMvXCIgKyBpZClcbiAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAudGhlbihkYXRhID0+IGRhdGEudHJpcClcbiAgICAgICAgICAgIC50aGVuKHRyaXAgPT4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgIHRyaXAsXG4gICAgICAgICAgICAgICAgdGhpcy5odHRwLmdldChDb25maWcuYXBpVXJsICsgXCIvbW9kZWxzL3RyYXZlbGxlcnMvP2lkc1tdPVwiICsgdHJpcC50cmF2ZWxsZXJzLmpvaW4oXCImaWRzW109XCIpKVxuICAgICAgICAgICAgICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gZGF0YS50cmF2ZWxsZXJzKVxuICAgICAgICAgICAgXSkpXG4gICAgICAgICAgICAudGhlbigoW3RyaXAsIHRyYXZlbGxlcnNdKSA9PiBQcm9taXNlLmFsbChbXG4gICAgICAgICAgICAgICAgdHJpcCxcbiAgICAgICAgICAgICAgICB0cmF2ZWxsZXJzLFxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy91c2Vycy8/aWRzW109XCIgKyB0cmF2ZWxsZXJzXG4gICAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoKHJlc3VsdCwgdHJhdmVsbGVyRGF0YSkgPT4gcmVzdWx0LmNvbmNhdChbdHJhdmVsbGVyRGF0YS51c2VyXSksIFtdKVxuICAgICAgICAgICAgICAgICAgICAuam9pbihcIiZpZHNbXT1cIikpXG4gICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiBkYXRhLnVzZXJzKVxuICAgICAgICAgICAgXSkpXG4gICAgICAgICAgICAudGhlbigoW3RyaXAsIHRyYXZlbGxlcnMsIHVzZXJzXSkgPT4gUHJvbWlzZS5hbGwoW1xuICAgICAgICAgICAgICAgIHRyaXAsXG4gICAgICAgICAgICAgICAgdHJhdmVsbGVycyxcbiAgICAgICAgICAgICAgICB1c2VycyxcbiAgICAgICAgICAgICAgICB0aGlzLmh0dHAuZ2V0KENvbmZpZy5hcGlVcmwgKyBcIi9tb2RlbHMvcGhvdG9zLz9pZHNbXT1cIiArIHRyaXAucGhvdG9zXG4gICAgICAgICAgICAgICAgICAgIC5jb25jYXQodHJhdmVsbGVycy5yZWR1Y2UoKHJlc3VsdCwgdHJhdmVsbGVyKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gdGhpcy5nZXRCeVZhbHVlKHVzZXJzLCB0cmF2ZWxsZXIudXNlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gcmVzdWx0LmNvbmNhdChbdXNlci5waG90b10pO1xuICAgICAgICAgICAgICAgICAgICB9LCBbXSkpXG4gICAgICAgICAgICAgICAgICAgIC5qb2luKFwiJmlkc1tdPVwiKSlcbiAgICAgICAgICAgICAgICAgICAgLnRvUHJvbWlzZSgpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXMuanNvbigpKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihkYXRhID0+IGRhdGEucGhvdG9zKVxuICAgICAgICAgICAgXSkpXG4gICAgICAgICAgICAudGhlbigoW3RyaXAsIHRyYXZlbGxlcnMsIHVzZXJzLCBwaG90b3NdKSA9PiBPYmplY3QuYXNzaWduKHt9LCB0cmlwLCB7XG4gICAgICAgICAgICAgICAgY292ZXJQaG90bzogdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgdHJpcC5jb3ZlclBob3RvKSxcbiAgICAgICAgICAgICAgICBwaG90b3M6IHRyaXAucGhvdG9zLm1hcChwaG90b0lkID0+IHRoaXMuZ2V0QnlWYWx1ZShwaG90b3MsIHBob3RvSWQpKSxcbiAgICAgICAgICAgICAgICB0cmF2ZWxsZXJzOiB0cmlwLnRyYXZlbGxlcnNcbiAgICAgICAgICAgICAgICAgICAgLm1hcCh0cmF2ZWxsZXJJZCA9PiB0aGlzLmdldEJ5VmFsdWUodHJhdmVsbGVycywgdHJhdmVsbGVySWQpKVxuICAgICAgICAgICAgICAgICAgICAubWFwKHRyYXZlbGxlciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB1c2VyID0gdGhpcy5nZXRCeVZhbHVlKHVzZXJzLCB0cmF2ZWxsZXIudXNlcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAvL2NvbnNvbGUuZGlyKHVzZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgLy9jb25zb2xlLmRpcihwaG90b3MpXG4gICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gT2JqZWN0LmFzc2lnbih7fSwgdHJhdmVsbGVyLCB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgdXNlcjogT2JqZWN0LmFzc2lnbih7fSwgdXNlciwge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwaG90bzogdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgdXNlci5waG90bylcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9KVxuICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgIH0pKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUuZnJvbVByb21pc2UocHJvbWlzZSk7XG4gICAgfVxuXG4gICAgaGFuZGxlRXJyb3JzKGVycm9yOiBSZXNwb25zZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhKU09OLnN0cmluZ2lmeShlcnJvci5qc29uKCkpKTtcbiAgICAgICAgcmV0dXJuIE9ic2VydmFibGUudGhyb3coZXJyb3IpO1xuICAgIH1cblxuICAgIGRlc2VyaWFsaXplKGRhdGE6IGFueSkge1xuICAgICAgICBjb25zdCB7IHRyaXBzLCBwaG90b3MsIHVzZXJzIH0gPSBkYXRhO1xuICAgICAgICBjb25zdCByZXN1bHQgPSB0cmlwcy5tYXAoaXRlbSA9PiB7XG4gICAgICAgICAgICBjb25zdCBvcmdhbmlzZXJEYXRhID0gdGhpcy5nZXRCeVZhbHVlKHVzZXJzLCBpdGVtLm9yZ2FuaXNlcik7XG4gICAgICAgICAgICBjb25zdCBvcmdhbmlzZXIgPSBPYmplY3QuYXNzaWduKHt9LCBvcmdhbmlzZXJEYXRhLCB7XG4gICAgICAgICAgICAgICAgcGhvdG86IHRoaXMuZ2V0QnlWYWx1ZShwaG90b3MsIG9yZ2FuaXNlckRhdGEucGhvdG8pLFxuICAgICAgICAgICAgICAgIHBob3Rvczogb3JnYW5pc2VyRGF0YS5waG90b3MubWFwKHBob3RvSWQgPT4gdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgcGhvdG9JZCkpXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIGNvbnN0IHRyaXAgPSBPYmplY3QuYXNzaWduKHt9LCBpdGVtLCB7XG4gICAgICAgICAgICAgICAgY292ZXJQaG90bzogdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgaXRlbS5jb3ZlclBob3RvKSxcbiAgICAgICAgICAgICAgICBwaG90b3M6IGl0ZW0ucGhvdG9zLm1hcChwaG90b0lkID0+IHRoaXMuZ2V0QnlWYWx1ZShwaG90b3MsIHBob3RvSWQpKSxcbiAgICAgICAgICAgICAgICBvcmdhbmlzZXJcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgcmV0dXJuIHRyaXA7XG4gICAgICAgIH0pO1xuXG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuXG4gICAgZ2V0QnlWYWx1ZShjb2xsZWN0aW9uLCBmaWVsZFZhbHVlLCBmaWVsZE5hbWUgPSAnaWQnKSB7XG4gICAgICAgIHJldHVybiBjb2xsZWN0aW9uLmZpbmQoaXRlbSA9PiBpdGVtW2ZpZWxkTmFtZV0gPT09IGZpZWxkVmFsdWUpO1xuICAgIH1cbn0iXX0=