"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var core_1 = require("@angular/core");
var http_1 = require("@angular/http");
var Rx_1 = require("rxjs/Rx");
require("rxjs/add/operator/map");
var config_1 = require("../config");
var trip_1 = require("./trip");
var TripListService = (function () {
    function TripListService(http) {
        this.http = http;
    }
    TripListService.prototype.load = function () {
        var _this = this;
        return this.http.get(config_1.Config.apiUrl + "/models/trips?action=includeRelationships")
            .map(function (res) { return res.json(); })
            .map(function (data) {
            var list = [];
            var trips = _this.deserialize(data);
            trips.forEach(function (trip) {
                list.push(new trip_1.Trip(trip.id, trip.name, trip.destination, trip.budgetFrom, trip.budgetTo, trip.approvedTravellersCount, trip.partnersReqd, trip.coverPhoto, trip.organiser, new Date(trip.dateStart), new Date(trip.dateEnd), [], [], []));
            });
            return list;
        })
            .catch(this.handleErrors);
    };
    TripListService.prototype.loadOne = function (id) {
        var _this = this;
        var promise = this.http.get(config_1.Config.apiUrl + "/models/trips/" + id)
            .toPromise()
            .then(function (res) { return res.json(); })
            .then(function (data) { return data.trip; })
            .then(function (trip) { return Promise.all([
            trip,
            _this.http.get(config_1.Config.apiUrl + "/models/photos/?ids[]=" + trip.photos.join("&ids[]="))
                .toPromise()
                .then(function (res) { return res.json(); })
                .then(function (data) { return data.photos; }),
            _this.http.get(config_1.Config.apiUrl + "/models/travellers/?ids[]=" + trip.travellers.join("&ids[]="))
                .toPromise()
                .then(function (res) { return res.json(); })
                .then(function (data) { return data.travellers; })
        ]); })
            .then(function (_a) {
            var trip = _a[0], photos = _a[1], travellers = _a[2];
            return Promise.all([
                trip,
                photos,
                travellers,
                _this.http.get(config_1.Config.apiUrl + "/models/users/?ids[]=" + travellers
                    .reduce(function (result, travellerData) { return result.concat([travellerData.user]); }, [])
                    .join("&ids[]="))
                    .toPromise()
                    .then(function (res) { return res.json(); })
                    .then(function (data) { return data.users; })
            ]);
        })
            .then(function (_a) {
            var trip = _a[0], photos = _a[1], travellers = _a[2], users = _a[3];
            return Object.assign({}, trip, {
                coverPhoto: _this.getByValue(photos, trip.coverPhoto),
                photos: trip.photos.map(function (photoId) { return _this.getByValue(photos, photoId); }),
                travellers: trip.travellers
                    .map(function (travellerId) { return _this.getByValue(travellers, travellerId); })
                    .map(function (traveller) {
                    console.dir(traveller);
                    console.log(users.length);
                    return Object.assign({}, traveller, { user: _this.getByValue(users, traveller.user) });
                })
            });
        });
        return Rx_1.Observable.fromPromise(promise);
    };
    TripListService.prototype.handleErrors = function (error) {
        console.log(JSON.stringify(error.json()));
        return Rx_1.Observable.throw(error);
    };
    TripListService.prototype.deserialize = function (data) {
        var _this = this;
        var trips = data.trips, photos = data.photos, users = data.users;
        var result = trips.map(function (item) {
            var organiserData = _this.getByValue(users, item.organiser);
            var organiser = Object.assign({}, organiserData, {
                photo: _this.getByValue(photos, organiserData.photo),
                photos: organiserData.photos.map(function (photoId) { return _this.getByValue(photos, photoId); })
            });
            var trip = Object.assign({}, item, {
                coverPhoto: _this.getByValue(photos, item.coverPhoto),
                photos: item.photos.map(function (photoId) { return _this.getByValue(photos, photoId); }),
                organiser: organiser
            });
            return trip;
        });
        return result;
    };
    TripListService.prototype.getByValue = function (collection, fieldValue, fieldName) {
        if (fieldName === void 0) { fieldName = 'id'; }
        return collection.find(function (item) { return item[fieldName] === fieldValue; });
    };
    return TripListService;
}());
TripListService = __decorate([
    core_1.Injectable(),
    __metadata("design:paramtypes", [http_1.Http])
], TripListService);
exports.TripListService = TripListService;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJpcC1saXN0LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0cmlwLWxpc3Quc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLHNDQUEyQztBQUMzQyxzQ0FBd0Q7QUFDeEQsOEJBQXFDO0FBQ3JDLGlDQUErQjtBQUUvQixvQ0FBbUM7QUFDbkMsK0JBQThCO0FBRzlCLElBQWEsZUFBZTtJQUN4Qix5QkFBb0IsSUFBVTtRQUFWLFNBQUksR0FBSixJQUFJLENBQU07SUFBSSxDQUFDO0lBRW5DLDhCQUFJLEdBQUo7UUFBQSxpQkEwQkM7UUF6QkcsTUFBTSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLGVBQU0sQ0FBQyxNQUFNLEdBQUcsMkNBQTJDLENBQUM7YUFDNUUsR0FBRyxDQUFDLFVBQUEsR0FBRyxJQUFJLE9BQUEsR0FBRyxDQUFDLElBQUksRUFBRSxFQUFWLENBQVUsQ0FBQzthQUN0QixHQUFHLENBQUMsVUFBQSxJQUFJO1lBQ0wsSUFBSSxJQUFJLEdBQUcsRUFBRSxDQUFDO1lBQ2QsSUFBTSxLQUFLLEdBQUcsS0FBSSxDQUFDLFdBQVcsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUNyQyxLQUFLLENBQUMsT0FBTyxDQUFDLFVBQUMsSUFBSTtnQkFDZixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksV0FBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQ3RCLElBQUksQ0FBQyxJQUFJLEVBQ1QsSUFBSSxDQUFDLFdBQVcsRUFDaEIsSUFBSSxDQUFDLFVBQVUsRUFDZixJQUFJLENBQUMsUUFBUSxFQUNiLElBQUksQ0FBQyx1QkFBdUIsRUFDNUIsSUFBSSxDQUFDLFlBQVksRUFDakIsSUFBSSxDQUFDLFVBQVUsRUFDZixJQUFJLENBQUMsU0FBUyxFQUNkLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsRUFDeEIsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxFQUN0QixF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QUM7SUFDTCxzQkFBQztBQUFELENBQUMsQUFuR0QsSUFtR0M7QUFuR1ksZUFBZTtJQUQzQixpQkFBVSxFQUFFO3FDQUVpQixXQUFJO0dBRHJCLGVBQWUsQ0FtRzNCO0FBbkdZLDBDQUFlIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgSW5qZWN0YWJsZSB9IGZyb20gXCJAYW5ndWxhci9jb3JlXCI7XG5pbXBvcnQgeyBIdHRwLCBIZWFkZXJzLCBSZXNwb25zZSB9IGZyb20gXCJAYW5ndWxhci9odHRwXCI7XG5pbXBvcnQgeyBPYnNlcnZhYmxlIH0gZnJvbSBcInJ4anMvUnhcIjtcbmltcG9ydCBcInJ4anMvYWRkL29wZXJhdG9yL21hcFwiO1xuXG5pbXBvcnQgeyBDb25maWcgfSBmcm9tIFwiLi4vY29uZmlnXCI7XG5pbXBvcnQgeyBUcmlwIH0gZnJvbSBcIi4vdHJpcFwiO1xuXG5ASW5qZWN0YWJsZSgpXG5leHBvcnQgY2xhc3MgVHJpcExpc3RTZXJ2aWNlIHtcbiAgICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHApIHsgfVxuXG4gICAgbG9hZCgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy90cmlwcz9hY3Rpb249aW5jbHVkZVJlbGF0aW9uc2hpcHNcIilcbiAgICAgICAgICAgIC5tYXAocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAubWFwKGRhdGEgPT4ge1xuICAgICAgICAgICAgICAgIGxldCBsaXN0ID0gW107XG4gICAgICAgICAgICAgICAgY29uc3QgdHJpcHMgPSB0aGlzLmRlc2VyaWFsaXplKGRhdGEpO1xuICAgICAgICAgICAgICAgIHRyaXBzLmZvckVhY2goKHRyaXApID0+IHtcbiAgICAgICAgICAgICAgICAgICAgbGlzdC5wdXNoKG5ldyBUcmlwKHRyaXAuaWQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLm5hbWUsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLmRlc3RpbmF0aW9uLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5idWRnZXRGcm9tLFxuICAgICAgICAgICAgICAgICAgICAgICAgdHJpcC5idWRnZXRUbyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAuYXBwcm92ZWRUcmF2ZWxsZXJzQ291bnQsXG4gICAgICAgICAgICAgICAgICAgICAgICB0cmlwLnBhcnRuZXJzUmVxZCxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAuY292ZXJQaG90byxcbiAgICAgICAgICAgICAgICAgICAgICAgIHRyaXAub3JnYW5pc2VyLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUodHJpcC5kYXRlU3RhcnQpLFxuICAgICAgICAgICAgICAgICAgICAgICAgbmV3IERhdGUodHJpcC5kYXRlRW5kKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIFtdLFxuICAgICAgICAgICAgICAgICAgICAgICAgW10sXG4gICAgICAgICAgICAgICAgICAgICAgICBbXVxuICAgICAgICAgICAgICAgICAgICApKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgICAgICByZXR1cm4gbGlzdDtcbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgICAuY2F0Y2godGhpcy5oYW5kbGVFcnJvcnMpO1xuICAgIH1cblxuICAgIGxvYWRPbmUoaWQ6IFN0cmluZykge1xuICAgICAgICBjb25zdCBwcm9taXNlID0gdGhpcy5odHRwLmdldChDb25maWcuYXBpVXJsICsgXCIvbW9kZWxzL3RyaXBzL1wiICsgaWQpXG4gICAgICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgICAgIC50aGVuKHJlcyA9PiByZXMuanNvbigpKVxuICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiBkYXRhLnRyaXApXG4gICAgICAgICAgICAudGhlbih0cmlwID0+IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICB0cmlwLFxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy9waG90b3MvP2lkc1tdPVwiICsgdHJpcC5waG90b3Muam9pbihcIiZpZHNbXT1cIikpXG4gICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiBkYXRhLnBob3RvcyksXG4gICAgICAgICAgICAgICAgdGhpcy5odHRwLmdldChDb25maWcuYXBpVXJsICsgXCIvbW9kZWxzL3RyYXZlbGxlcnMvP2lkc1tdPVwiICsgdHJpcC50cmF2ZWxsZXJzLmpvaW4oXCImaWRzW109XCIpKVxuICAgICAgICAgICAgICAgICAgICAudG9Qcm9taXNlKClcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4ocmVzID0+IHJlcy5qc29uKCkpXG4gICAgICAgICAgICAgICAgICAgIC50aGVuKGRhdGEgPT4gZGF0YS50cmF2ZWxsZXJzKVxuICAgICAgICAgICAgXSkpXG4gICAgICAgICAgICAudGhlbigoW3RyaXAsIHBob3RvcywgdHJhdmVsbGVyc10pID0+IFByb21pc2UuYWxsKFtcbiAgICAgICAgICAgICAgICB0cmlwLFxuICAgICAgICAgICAgICAgIHBob3RvcyxcbiAgICAgICAgICAgICAgICB0cmF2ZWxsZXJzLFxuICAgICAgICAgICAgICAgIHRoaXMuaHR0cC5nZXQoQ29uZmlnLmFwaVVybCArIFwiL21vZGVscy91c2Vycy8/aWRzW109XCIgKyB0cmF2ZWxsZXJzXG4gICAgICAgICAgICAgICAgICAgIC5yZWR1Y2UoKHJlc3VsdCwgdHJhdmVsbGVyRGF0YSkgPT4gcmVzdWx0LmNvbmNhdChbdHJhdmVsbGVyRGF0YS51c2VyXSksIFtdKVxuICAgICAgICAgICAgICAgICAgICAuam9pbihcIiZpZHNbXT1cIikpXG4gICAgICAgICAgICAgICAgICAgIC50b1Byb21pc2UoKVxuICAgICAgICAgICAgICAgICAgICAudGhlbihyZXMgPT4gcmVzLmpzb24oKSlcbiAgICAgICAgICAgICAgICAgICAgLnRoZW4oZGF0YSA9PiBkYXRhLnVzZXJzKVxuICAgICAgICAgICAgXSkpXG4gICAgICAgICAgICAudGhlbigoW3RyaXAsIHBob3RvcywgdHJhdmVsbGVycywgdXNlcnNdKSA9PiBPYmplY3QuYXNzaWduKHt9LCB0cmlwLCB7XG4gICAgICAgICAgICAgICAgY292ZXJQaG90bzogdGhpcy5nZXRCeVZhbHVlKHBob3RvcywgdHJpcC5jb3ZlclBob3RvKSxcbiAgICAgICAgICAgICAgICBwaG90b3M6IHRyaXAucGhvdG9zLm1hcChwaG90b0lkID0+IHRoaXMuZ2V0QnlWYWx1ZShwaG90b3MsIHBob3RvSWQpKSxcbiAgICAgICAgICAgICAgICB0cmF2ZWxsZXJzOiB0cmlwLnRyYXZlbGxlcnNcbiAgICAgICAgICAgICAgICAgICAgLm1hcCh0cmF2ZWxsZXJJZCA9PiB0aGlzLmdldEJ5VmFsdWUodHJhdmVsbGVycywgdHJhdmVsbGVySWQpKVxuICAgICAgICAgICAgICAgICAgICAubWFwKHRyYXZlbGxlciA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zb2xlLmRpcih0cmF2ZWxsZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgY29uc29sZS5sb2codXNlcnMubGVuZ3RoKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBPYmplY3QuYXNzaWduKHt9LCB0cmF2ZWxsZXIsIHsgdXNlcjogdGhpcy5nZXRCeVZhbHVlKHVzZXJzLCB0cmF2ZWxsZXIudXNlcikgfSk7XG4gICAgICAgICAgICAgICAgICAgIH0pXG4gICAgICAgICAgICB9KSk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLmZyb21Qcm9taXNlKHByb21pc2UpO1xuICAgIH1cblxuICAgIGhhbmRsZUVycm9ycyhlcnJvcjogUmVzcG9uc2UpIHtcbiAgICAgICAgY29uc29sZS5sb2coSlNPTi5zdHJpbmdpZnkoZXJyb3IuanNvbigpKSk7XG4gICAgICAgIHJldHVybiBPYnNlcnZhYmxlLnRocm93KGVycm9yKTtcbiAgICB9XG5cbiAgICBkZXNlcmlhbGl6ZShkYXRhOiBhbnkpIHtcbiAgICAgICAgY29uc3QgeyB0cmlwcywgcGhvdG9zLCB1c2VycyB9ID0gZGF0YTtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gdHJpcHMubWFwKGl0ZW0gPT4ge1xuICAgICAgICAgICAgY29uc3Qgb3JnYW5pc2VyRGF0YSA9IHRoaXMuZ2V0QnlWYWx1ZSh1c2VycywgaXRlbS5vcmdhbmlzZXIpO1xuICAgICAgICAgICAgY29uc3Qgb3JnYW5pc2VyID0gT2JqZWN0LmFzc2lnbih7fSwgb3JnYW5pc2VyRGF0YSwge1xuICAgICAgICAgICAgICAgIHBob3RvOiB0aGlzLmdldEJ5VmFsdWUocGhvdG9zLCBvcmdhbmlzZXJEYXRhLnBob3RvKSxcbiAgICAgICAgICAgICAgICBwaG90b3M6IG9yZ2FuaXNlckRhdGEucGhvdG9zLm1hcChwaG90b0lkID0+IHRoaXMuZ2V0QnlWYWx1ZShwaG90b3MsIHBob3RvSWQpKVxuICAgICAgICAgICAgfSk7XG4gICAgICAgICAgICBjb25zdCB0cmlwID0gT2JqZWN0LmFzc2lnbih7fSwgaXRlbSwge1xuICAgICAgICAgICAgICAgIGNvdmVyUGhvdG86IHRoaXMuZ2V0QnlWYWx1ZShwaG90b3MsIGl0ZW0uY292ZXJQaG90byksXG4gICAgICAgICAgICAgICAgcGhvdG9zOiBpdGVtLnBob3Rvcy5tYXAocGhvdG9JZCA9PiB0aGlzLmdldEJ5VmFsdWUocGhvdG9zLCBwaG90b0lkKSksXG4gICAgICAgICAgICAgICAgb3JnYW5pc2VyXG4gICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIHJldHVybiB0cmlwO1xuICAgICAgICB9KTtcblxuICAgICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGdldEJ5VmFsdWUoY29sbGVjdGlvbiwgZmllbGRWYWx1ZSwgZmllbGROYW1lID0gJ2lkJykge1xuICAgICAgICByZXR1cm4gY29sbGVjdGlvbi5maW5kKGl0ZW0gPT4gaXRlbVtmaWVsZE5hbWVdID09PSBmaWVsZFZhbHVlKTtcbiAgICB9XG59Il19